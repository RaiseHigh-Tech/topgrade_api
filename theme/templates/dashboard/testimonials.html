{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}
  Testimonials Management
{% endblock %}

{% block content %}
  <!-- start page title -->
  <div class="row">
    <div class="col-12">
      <div class="page-title-box d-sm-flex align-items-center justify-content-between">
        <h4 class="mb-sm-0">Testimonials</h4>
        <div class="page-title-right">
          <ol class="breadcrumb m-0">
            <li class="breadcrumb-item">
              <a href="{% url 'dashboard:dashboard' %}">Dashboard</a>
            </li>
            <li class="breadcrumb-item active">Testimonials</li>
          </ol>
        </div>
      </div>
    </div>
  </div>
  <!-- end page title -->

  <div class="row">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <h5 class="card-title mb-0 flex-grow-1">Manage Testimonials</h5>
            <div class="flex-shrink-0">
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTestimonialModal"><i class="ri-add-line align-bottom me-1"></i> Add Testimonial</button>
            </div>
          </div>
        </div>
        <div class="card-body">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}

          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle table-nowrap mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col">Avatar</th>
                  <th scope="col">Name</th>
                  <th scope="col">Field of Study</th>
                  <th scope="col">Title</th>
                  <th scope="col">Status</th>
                  <th scope="col">Created</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for testimonial in testimonials %}
                  <tr>
                    <td>
                      {% if testimonial.avatar_image %}
                        <img src="{{ testimonial.avatar_image.url }}" alt="{{ testimonial.name }}" class="rounded-circle avatar-xs" />
                      {% else %}
                        <div class="avatar-xs">
                          <span class="avatar-title rounded-circle bg-light text-body">{{ testimonial.name|first|upper }}</span>
                        </div>
                      {% endif %}
                    </td>
                    <td>{{ testimonial.name }}</td>
                    <td>{{ testimonial.field_of_study }}</td>
                    <td>{{ testimonial.title|truncatechars:30 }}</td>
                    <td>
                      <form method="post" action="{% url 'dashboard:toggle_testimonial_status' testimonial.id %}" class="d-inline">
                        {% csrf_token %}
                        {% if testimonial.is_active %}
                          <button type="submit" class="btn btn-sm btn-success"><i class="ri-eye-line"></i> Active</button>
                        {% else %}
                          <button type="submit" class="btn btn-sm btn-warning"><i class="ri-eye-off-line"></i> Inactive</button>
                        {% endif %}
                      </form>
                    </td>
                    <td>{{ testimonial.created_at|date:'M d, Y' }}</td>
                    <td>
                      <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-soft-primary edit-testimonial-btn" 
                                data-testimonial-id="{{ testimonial.id }}" 
                                data-name="{{ testimonial.name }}" 
                                data-field="{{ testimonial.field_of_study }}" 
                                data-title="{{ testimonial.title }}" 
                                data-content="{{ testimonial.content }}" 
                                data-bs-toggle="modal" 
                                data-bs-target="#editTestimonialModal">
                          <i class="ri-pencil-fill"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-soft-danger delete-testimonial-btn" 
                                data-testimonial-id="{{ testimonial.id }}" 
                                data-name="{{ testimonial.name }}" 
                                data-bs-toggle="modal" 
                                data-bs-target="#deleteTestimonialModal">
                          <i class="ri-delete-bin-fill"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="7" class="text-center py-4">
                      <div class="d-flex flex-column align-items-center">
                        <i class="ri-chat-quote-line display-4 text-muted mb-3"></i>
                        <h5 class="text-muted">No testimonials found</h5>
                        <p class="text-muted mb-0">Start by adding your first testimonial</p>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Testimonial Modal -->
  <div class="modal fade" id="addTestimonialModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Testimonial</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" enctype="multipart/form-data" action="{% url 'dashboard:add_testimonial' %}">
          {% csrf_token %}
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="add-name" class="form-label">Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="add-name" name="name" required />
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="add-field" class="form-label">Field of Study <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="add-field" name="field_of_study" required />
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="add-title" class="form-label">Testimonial Title <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="add-title" name="title" required />
            </div>
            <div class="mb-3">
              <label for="add-content" class="form-label">Testimonial Content <span class="text-danger">*</span></label>
              <textarea class="form-control" id="add-content" name="content" rows="4" required></textarea>
            </div>
            <div class="mb-3">
              <label for="add-avatar" class="form-label">Avatar Image</label>
              <input type="file" class="form-control" id="add-avatar" name="avatar_image" accept="image/*" />
              <small class="text-muted">Optional. Recommended size: 150x150px</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Testimonial</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Testimonial Modal -->
  <div class="modal fade" id="editTestimonialModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Testimonial</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" enctype="multipart/form-data" id="editTestimonialForm">
          {% csrf_token %}
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="edit-name" class="form-label">Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="edit-name" name="name" required />
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="edit-field" class="form-label">Field of Study <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="edit-field" name="field_of_study" required />
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="edit-title" class="form-label">Testimonial Title <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="edit-title" name="title" required />
            </div>
            <div class="mb-3">
              <label for="edit-content" class="form-label">Testimonial Content <span class="text-danger">*</span></label>
              <textarea class="form-control" id="edit-content" name="content" rows="4" required></textarea>
            </div>
            <div class="mb-3">
              <label for="edit-avatar" class="form-label">Avatar Image</label>
              <input type="file" class="form-control" id="edit-avatar" name="avatar_image" accept="image/*" />
              <small class="text-muted">Optional. Leave empty to keep current image.</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Testimonial</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Testimonial Modal -->
  <div class="modal fade" id="deleteTestimonialModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete Testimonial</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="text-center">
            <i class="ri-delete-bin-line display-4 text-danger mb-3"></i>
            <h5>Are you sure?</h5>
            <p class="text-muted mb-0">
              You are about to delete the testimonial by <strong id="delete-testimonial-name"></strong>. This action cannot be undone.
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <form method="post" id="deleteTestimonialForm" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Delete Testimonial</button>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block js %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Edit testimonial modal population
      document.querySelectorAll('.edit-testimonial-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const testimonialId = this.dataset.testimonialId
          const name = this.dataset.name
          const field = this.dataset.field
          const title = this.dataset.title
          const content = this.dataset.content
    
          // Populate form fields
          document.getElementById('edit-name').value = name
          document.getElementById('edit-field').value = field
          document.getElementById('edit-title').value = title
          document.getElementById('edit-content').value = content
    
          // Set form action
          document.getElementById('editTestimonialForm').action = '{% url "dashboard:edit_testimonial" 0 %}'.replace('0', testimonialId)
        })
      })
    
      // Delete testimonial modal population
      document.querySelectorAll('.delete-testimonial-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const testimonialId = this.dataset.testimonialId
          const name = this.dataset.name
    
          // Set testimonial name in modal
          document.getElementById('delete-testimonial-name').textContent = name
    
          // Set form action
          document.getElementById('deleteTestimonialForm').action = '{% url "dashboard:delete_testimonial" 0 %}'.replace('0', testimonialId)
        })
      })
    })
  </script>
{% endblock %}

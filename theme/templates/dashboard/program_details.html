{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}
  Program Details - {{ program.subtitle }}
{% endblock %}

{% block css %}
  <!-- Additional CSS for tabs and charts -->
  <link href="{% static 'assets/dashboard/libs/swiper/swiper-bundle.min.css' %}" rel="stylesheet" type="text/css" />
  <style>
    .nav-pills .nav-link.active {
      background-color: #405189;
    }
    .progress-sm {
      height: 0.5rem;
    }
    .avatar-title {
      align-items: center;
      background-color: #405189;
      color: #fff;
      display: flex;
      font-weight: 500;
      height: 100%;
      justify-content: center;
      width: 100%;
    }
    .card-hover:hover {
      transform: translateY(-2px);
      transition: all 0.3s ease;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
  </style>
{% endblock %}

{% block content %}
  <!-- Program Header -->
  <div class="row">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-lg-3">
              {% if program.image %}
                <img src="{{ program.image.url }}" alt="{{ program.subtitle }}" class="img-fluid rounded" />
              {% else %}
                <img src="{% static 'assets/dashboard/img/img-1.jpg' %}" alt="{{ program.subtitle }}" class="img-fluid rounded" />
              {% endif %}
            </div>
            <div class="col-lg-9">
              <div class="d-flex align-items-center">
                <h4 class="mb-0 me-3">{{ program.title }} {{ program.subtitle }}</h4>
                {% if program.is_best_seller %}
                  <span class="badge bg-warning text-dark">Best Seller</span>
                {% endif %}
                {% if program.category.name == 'Advanced Program' %}
                  <span class="badge bg-primary ms-2"><i class="fas fa-crown"></i> Advanced</span>
                {% endif %}
              </div>
              <div class="row mt-4">
                <div>
                  <h5 class="text-primary mb-0 me-2">₹{{ program.discounted_price|floatformat:0 }}</h5>
                  {% if program.discount_percentage > 0 %}
                    <span class="text-decoration-line-through text-muted me-2">₹{{ program.price|floatformat:0 }}</span>
                    <span class="badge bg-success">{{ program.discount_percentage|floatformat:0 }}% OFF</span>
                  {% endif %}
                </div>
              </div>
              <div class="row mt-4 bg-light p-2">
                <div class="col-sm-6 col-lg-3">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                      <i class="ri-calendar-line text-primary fs-17"></i>
                    </div>
                    <div class="flex-grow-1 ms-2">
                      <p class="text-muted mb-0">Batch Starts</p>
                      <h6 class="mb-0">{{ program.batch_starts }}</h6>
                    </div>
                  </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                      <i class="ri-time-line text-primary fs-17"></i>
                    </div>
                    <div class="flex-grow-1 ms-2">
                      <p class="text-muted mb-0">Duration</p>
                      <h6 class="mb-0">{{ program.duration }}</h6>
                    </div>
                  </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                      <i class="ri-user-line text-primary fs-17"></i>
                    </div>
                    <div class="flex-grow-1 ms-2">
                      <p class="text-muted mb-0">Available Slots</p>
                      <h6 class="mb-0">{{ program.available_slots }}</h6>
                    </div>
                  </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                      <i class="ri-star-fill text-warning fs-17"></i>
                    </div>
                    <div class="flex-grow-1 ms-2">
                      <p class="text-muted mb-0">Rating</p>
                      <h6 class="mb-0">{{ program.program_rating|floatformat:1 }}/5.0</h6>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabbed Content -->
  <div class="row">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-header">
          <ul class="nav nav-pills nav-justified" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" data-bs-toggle="pill" href="#overview-tab" role="tab"><i class="ri-information-line align-bottom me-1"></i> Overview</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="pill" href="#curriculum-tab" role="tab"><i class="ri-book-open-line align-bottom me-1"></i> Curriculum</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="pill" href="#students-tab" role="tab"><i class="ri-user-line align-bottom me-1"></i> Students</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="pill" href="#analytics-tab" role="tab"><i class="ri-bar-chart-line align-bottom me-1"></i> Analytics</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="pill" href="#reviews-tab" role="tab"><i class="ri-star-line align-bottom me-1"></i> Reviews</a>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview-tab" role="tabpanel">
              <div class="row">
                <div class="col-lg-12">
                  <h5 class="mb-3">Program Description</h5>
                  <div class="text-muted">
                    {% if program.description %}
                      {{ program.description|linebreaks }}
                    {% else %}
                      <p>Detailed program description will be available soon. This comprehensive program is designed to provide in-depth knowledge and practical skills in the field.</p>
                    {% endif %}
                  </div>

                  <!-- Market Statistics -->
                  <div class="row mt-4">
                    {% if program.job_openings %}
                      <div class="col-md-4">
                        <div class="card card-hover text-center border">
                          <div class="card-body">
                            <div class="avatar-sm mx-auto mb-3">
                              <div class="avatar-title rounded-circle bg-primary">
                                <i class="ri-briefcase-line fs-16"></i>
                              </div>
                            </div>
                            <h5 class="fs-15 mb-1">{{ program.job_openings }}</h5>
                            <p class="text-muted mb-0">Job Openings</p>
                          </div>
                        </div>
                      </div>
                    {% endif %}

                    {% if program.global_market_size %}
                      <div class="col-md-4">
                        <div class="card card-hover text-center border">
                          <div class="card-body">
                            <div class="avatar-sm mx-auto mb-3">
                              <div class="avatar-title rounded-circle bg-success">
                                <i class="ri-global-line fs-16"></i>
                              </div>
                            </div>
                            <h5 class="fs-15 mb-1">{{ program.global_market_size }}</h5>
                            <p class="text-muted mb-0">Market Size</p>
                          </div>
                        </div>
                      </div>
                    {% endif %}

                    {% if program.avg_annual_salary %}
                      <div class="col-md-4">
                        <div class="card card-hover text-center border">
                          <div class="card-body">
                            <div class="avatar-sm mx-auto mb-3">
                              <div class="avatar-title rounded-circle bg-warning">
                                <i class="ri-money-dollar-circle-line fs-16"></i>
                              </div>
                            </div>
                            <h5 class="fs-15 mb-1">{{ program.avg_annual_salary }}</h5>
                            <p class="text-muted mb-0">Avg. Salary</p>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <!-- Curriculum Tab -->
            <div class="tab-pane fade" id="curriculum-tab" role="tabpanel">
              <div class="row">
                <div class="col-12">
                  <h5 class="mb-3">Course Curriculum</h5>
                  {% if program.syllabuses.all %}
                    <div class="accordion" id="curriculumAccordion">
                      {% for syllabus in program.syllabuses.all %}
                        <div class="accordion-item">
                          <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                            <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}"
                              type="button"
                              data-bs-toggle="collapse"
                              data-bs-target="#collapse{{ forloop.counter }}"
                              aria-expanded="{% if forloop.first %}
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                true































                              {% else %}
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                
                                false































                              {% endif %}"
                              aria-controls="collapse{{ forloop.counter }}">
                              <div class="d-flex align-items-center w-100">
                                <div class="flex-shrink-0">
                                  <div class="avatar-xs">
                                    <div class="avatar-title rounded-circle bg-primary text-white">{{ forloop.counter }}</div>
                                  </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                  <h6 class="mb-0">{{ syllabus.module_title }}</h6>
                                  <p class="text-muted mb-0 fs-12">{{ syllabus.topics.count }} topics</p>
                                </div>
                                <div class="flex-shrink-0">
                                  <span class="badge bg-success-subtle text-success">{{ syllabus.topics.count }} videos</span>
                                </div>
                              </div>
                            </button>
                          </h2>
                          <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#curriculumAccordion">
                            <div class="accordion-body">
                              {% if syllabus.topics.all %}
                                <div class="list-group list-group-flush">
                                  {% for topic in syllabus.topics.all %}
                                    <div class="list-group-item border-0 ps-0">
                                      <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                          <div class="avatar-xs">
                                            <div class="avatar-title rounded bg-light text-primary">
                                              {% if topic.is_free_trial %}
                                                <i class="ri-play-circle-line"></i>
                                              {% else %}
                                                <i class="ri-lock-line"></i>
                                              {% endif %}
                                            </div>
                                          </div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                          <h6 class="mb-1">{{ topic.topic_title }}</h6>
                                          {% if topic.description %}
                                            <p class="text-muted mb-0 fs-13">{{ topic.description|truncatechars:100 }}</p>
                                          {% endif %}
                                        </div>
                                        <div class="flex-shrink-0">
                                          <div class="d-flex align-items-center gap-2">
                                            {% if topic.video_duration %}
                                              <span class="badge bg-primary-subtle text-primary">{{ topic.video_duration }}</span>
                                            {% endif %}
                                            {% if topic.is_free_trial %}
                                              <span class="badge bg-success">Free</span>
                                            {% endif %}
                                            {% if topic.is_intro %}
                                              <span class="badge bg-info">Intro</span>
                                            {% endif %}
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  {% endfor %}
                                </div>
                              {% else %}
                                <p class="text-muted mb-0">No topics available for this module.</p>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="text-center py-5">
                      <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-primary-subtle text-primary rounded-circle fs-4">
                          <i class="ri-book-open-line"></i>
                        </div>
                      </div>
                      <h5 class="fs-16">No Curriculum Available</h5>
                      <p class="text-muted mb-0">The curriculum for this program is being prepared and will be available soon.</p>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Students Tab -->
            <div class="tab-pane fade" id="students-tab" role="tabpanel">
              <div class="row">
                <div class="col-lg-8">
                  <h5 class="mb-3">Enrolled Students</h5>
                  {% if enrolled_students %}
                    <div class="row">
                      {% for purchase in enrolled_students %}
                        <div class="col-md-6 mb-3">
                          <div class="card border">
                            <div class="card-body">
                              <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                  <img src="{% static 'assets/dashboard/img/users/avatar-1.jpg' %}" alt="" class="avatar-sm rounded-circle" />
                                </div>
                                <div class="flex-grow-1 ms-3">
                                  <h6 class="mb-1">{{ purchase.user.fullname|default:purchase.user.email }}</h6>
                                  <p class="text-muted mb-0 fs-13">{{ purchase.user.email }}</p>
                                  <p class="text-muted mb-0 fs-12">Enrolled: {{ purchase.purchase_date|date:'M d, Y' }}</p>
                                </div>
                                <div class="flex-shrink-0">
                                  <span class="badge bg-success">{{ purchase.get_status_display }}</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="text-center py-5">
                      <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-primary-subtle text-primary rounded-circle fs-4">
                          <i class="ri-user-line"></i>
                        </div>
                      </div>
                      <h5 class="fs-16">No Students Enrolled</h5>
                      <p class="text-muted mb-0">This program doesn't have any enrolled students yet.</p>
                    </div>
                  {% endif %}
                </div>
                <div class="col-lg-4">
                  <div class="card border">
                    <div class="card-header">
                      <h6 class="card-title mb-0">Enrollment Stats</h6>
                    </div>
                    <div class="card-body">
                      <div class="text-center">
                        <h3 class="text-primary">{{ total_enrollments|default:0 }}</h3>
                        <p class="text-muted mb-3">Total Enrollments</p>
                      </div>
                      <div class="row text-center">
                        <div class="col-6">
                          <h5 class="text-success">{{ active_enrollments|default:0 }}</h5>
                          <p class="text-muted mb-0 fs-13">Active</p>
                        </div>
                        <div class="col-6">
                          <h5 class="text-info">{{ available_slots|default:program.available_slots }}</h5>
                          <p class="text-muted mb-0 fs-13">Available</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-pane fade" id="analytics-tab" role="tabpanel">
              <div class="row">
                <div class="col-lg-3 col-md-6">
                  <div class="card border">
                    <div class="card-body text-center">
                      <div class="avatar-sm mx-auto mb-3">
                        <div class="avatar-title rounded-circle bg-primary">
                          <i class="ri-eye-line fs-16"></i>
                        </div>
                      </div>
                      <h5 class="mb-1">{{ program_views|default:0 }}</h5>
                      <p class="text-muted mb-0">Total Views</p>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6">
                  <div class="card border">
                    <div class="card-body text-center">
                      <div class="avatar-sm mx-auto mb-3">
                        <div class="avatar-title rounded-circle bg-success">
                          <i class="ri-user-add-line fs-16"></i>
                        </div>
                      </div>
                      <h5 class="mb-1">{{ enrollment_rate|default:0 }}%</h5>
                      <p class="text-muted mb-0">Enrollment Rate</p>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6">
                  <div class="card border">
                    <div class="card-body text-center">
                      <div class="avatar-sm mx-auto mb-3">
                        <div class="avatar-title rounded-circle bg-warning">
                          <i class="ri-bookmark-line fs-16"></i>
                        </div>
                      </div>
                      <h5 class="mb-1">{{ bookmarks_count|default:0 }}</h5>
                      <p class="text-muted mb-0">Bookmarks</p>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6">
                  <div class="card border">
                    <div class="card-body text-center">
                      <div class="avatar-sm mx-auto mb-3">
                        <div class="avatar-title rounded-circle bg-info">
                          <i class="ri-money-dollar-circle-line fs-16"></i>
                        </div>
                      </div>
                      <h5 class="mb-1">₹{{ total_revenue|default:0 }}</h5>
                      <p class="text-muted mb-0">Revenue</p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-12">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="card-title mb-0">Enrollment Trends</h6>
                    </div>
                    <div class="card-body">
                      <div id="enrollmentChart" style="height: 300px;"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Reviews Tab -->
            <div class="tab-pane fade" id="reviews-tab" role="tabpanel">
              <div class="row">
                <div class="col-lg-8">
                  <h5 class="mb-3">Student Reviews</h5>
                  {% if reviews %}
                    {% for review in reviews %}
                      <div class="card border mb-3">
                        <div class="card-body">
                          <div class="d-flex align-items-start">
                            <div class="flex-shrink-0">
                              <img src="{% static 'assets/dashboard/img/users/avatar-1.jpg' %}" alt="" class="avatar-sm rounded-circle" />
                            </div>
                            <div class="flex-grow-1 ms-3">
                              <h6 class="mb-1">{{ review.user.fullname|default:review.user.email }}</h6>
                              <div class="d-flex align-items-center mb-2">
                                <div class="me-2">
                                  {# prettier-ignore #}
                                  {% for i in "12345" %}
                                                                {% if forloop.counter <= review.rating %}
                                                                    <i class="ri-star-fill text-warning"></i>
                                                                {% else %}
                                                                    <i class="ri-star-line text-muted"></i>
                                                                {% endif %}
                                                            {% endfor %}
                                </div>
                                <span class="text-muted fs-13">{{ review.created_at|date:'M d, Y' }}</span>
                              </div>
                              <p class="text-muted mb-0">{{ review.comment }}</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="text-center py-5">
                      <div class="avatar-lg mx-auto mb-4">
                        <div class="avatar-title bg-primary-subtle text-primary rounded-circle fs-4">
                          <i class="ri-star-line"></i>
                        </div>
                      </div>
                      <h5 class="fs-16">No Reviews Yet</h5>
                      <p class="text-muted mb-0">This program doesn't have any reviews yet.</p>
                    </div>
                  {% endif %}
                </div>
                <div class="col-lg-4">
                  <div class="card border">
                    <div class="card-header">
                      <h6 class="card-title mb-0">Rating Overview</h6>
                    </div>
                    <div class="card-body text-center">
                      <h2 class="text-primary mb-1">{{ program.program_rating|floatformat:1 }}</h2>
                      <div class="mb-2">
                        {# prettier-ignore #}
                        {% for i in "12345" %}
                                                {% if forloop.counter <= program.program_rating %}
                                                    <i class="ri-star-fill text-warning fs-16"></i>
                                                {% else %}
                                                    <i class="ri-star-line text-muted fs-16"></i>
                                                {% endif %}
                                            {% endfor %}
                      </div>
                      <p class="text-muted mb-0">Based on {{ reviews_count|default:0 }} reviews</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block js %}
  <!-- ApexCharts for analytics -->
  <script src="{% static 'assets/dashboard/libs/apexcharts/apexcharts.min.js' %}"></script>
  <script>
    // Sample chart for enrollment trends
    document.addEventListener('DOMContentLoaded', function () {
      if (document.getElementById('enrollmentChart')) {
        var options = {
          series: [
            {
              name: 'Enrollments',
              data: [10, 15, 8, 25, 18, 30, 22]
            }
          ],
          chart: {
            type: 'area',
            height: 300,
            toolbar: {
              show: false
            }
          },
          colors: ['#405189'],
          stroke: {
            curve: 'smooth'
          },
          xaxis: {
            categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul']
          },
          fill: {
            type: 'gradient',
            gradient: {
              shadeIntensity: 1,
              opacityFrom: 0.7,
              opacityTo: 0.3,
              stops: [0, 90, 100]
            }
          }
        }
    
        var chart = new ApexCharts(document.querySelector('#enrollmentChart'), options)
        chart.render()
      }
    })
  </script>
{% endblock %}

{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}
  Certificates Management
{% endblock %}

{% block content %}
  <!-- start page title -->
  <div class="row">
    <div class="col-12">
      <div class="page-title-box d-sm-flex align-items-center justify-content-between">
        <h4 class="mb-sm-0">Certificates</h4>
        <div class="page-title-right">
          <ol class="breadcrumb m-0">
            <li class="breadcrumb-item">
              <a href="{% url 'dashboard:dashboard' %}">Dashboard</a>
            </li>
            <li class="breadcrumb-item active">Certificates</li>
          </ol>
        </div>
      </div>
    </div>
  </div>
  <!-- end page title -->

  <div class="row">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <h5 class="card-title mb-0 flex-grow-1">Manage Program Certificates</h5>
            <div class="flex-shrink-0">
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCertificateModal"><i class="ri-add-line align-bottom me-1"></i> Add Certificate</button>
            </div>
          </div>
        </div>
        <div class="card-body">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}

          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle table-nowrap mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col">Preview</th>
                  <th scope="col">Program</th>
                  <th scope="col">Uploaded</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for certificate in certificates %}
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        <img src="{{ certificate.certificate_image.url }}" alt="Certificate Preview" class="rounded border" style="width: 80px; height: 60px; object-fit: cover;" />
                      </div>
                    </td>
                    <td>
                      <div>
                        <h6 class="mb-1">{{ certificate.program.title }}</h6>
                        {% if certificate.program.subtitle %}
                          <p class="text-muted mb-0 small">{{ certificate.program.subtitle }}</p>
                        {% endif %}
                      </div>
                    </td>
                    <td>{{ certificate.created_at|date:'M d, Y' }}</td>
                    <td>
                      <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-soft-info" data-bs-toggle="modal" data-bs-target="#viewCertificateModal" data-image-url="{{ certificate.certificate_image.url }}" data-program-title="{{ certificate.program.title }}"><i class="ri-eye-line"></i></button>
                        <button type="button" class="btn btn-sm btn-soft-primary edit-certificate-btn" data-certificate-id="{{ certificate.id }}" data-program-id="{{ certificate.program.id }}" data-bs-toggle="modal" data-bs-target="#editCertificateModal"><i class="ri-pencil-fill"></i></button>
                        <button type="button" class="btn btn-sm btn-soft-danger delete-certificate-btn" data-certificate-id="{{ certificate.id }}" data-program-title="{{ certificate.program.title }}" data-bs-toggle="modal" data-bs-target="#deleteCertificateModal"><i class="ri-delete-bin-fill"></i></button>
                      </div>
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="4" class="text-center py-4">
                      <div class="d-flex flex-column align-items-center">
                        <i class="ri-award-line display-4 text-muted mb-3"></i>
                        <h5 class="text-muted">No certificates found</h5>
                        <p class="text-muted mb-0">Start by adding your first certificate</p>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Certificate Modal -->
  <div class="modal fade" id="addCertificateModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Certificate</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" enctype="multipart/form-data" action="{% url 'dashboard:add_certificate' %}">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-3">
              <label for="add-program" class="form-label">Program <span class="text-danger">*</span></label>
              <select class="form-select" id="add-program" name="program" required>
                <option value="">Select a program...</option>
                {% for program in programs %}
                  <option value="{{ program.id }}">
                    {{ program.title }}{% if program.subtitle %}
                      - {{ program.subtitle }}
                    {% endif %}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="add-certificate-image" class="form-label">Certificate Image <span class="text-danger">*</span></label>
              <input type="file" class="form-control" id="add-certificate-image" name="certificate_image" accept="image/*" required />
              <small class="text-muted">Upload certificate image (JPG, PNG, etc.)</small>
            </div>
            <div class="mb-3">
              <div class="certificate-preview" id="add-preview" style="display: none;">
                <label class="form-label">Preview:</label>
                <div class="border rounded p-2">
                  <img id="add-preview-img" src="" alt="Certificate Preview" class="img-fluid" style="max-height: 200px;" />
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Certificate</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Certificate Modal -->
  <div class="modal fade" id="editCertificateModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Certificate</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" enctype="multipart/form-data" id="editCertificateForm">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-3">
              <label for="edit-program" class="form-label">Program <span class="text-danger">*</span></label>
              <select class="form-select" id="edit-program" name="program" required>
                <option value="">Select a program...</option>
                {% for program in programs %}
                  <option value="{{ program.id }}">
                    {{ program.title }}{% if program.subtitle %}
                      - {{ program.subtitle }}
                    {% endif %}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="edit-certificate-image" class="form-label">Certificate Image</label>
              <input type="file" class="form-control" id="edit-certificate-image" name="certificate_image" accept="image/*" />
              <small class="text-muted">Leave empty to keep current image</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Certificate</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- View Certificate Modal -->
  <div class="modal fade" id="viewCertificateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="view-modal-title">Certificate Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <img id="view-certificate-image" src="" alt="Certificate" class="img-fluid rounded border" />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <a id="download-certificate" href="" class="btn btn-primary" download><i class="ri-download-line me-1"></i> Download</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Certificate Modal -->
  <div class="modal fade" id="deleteCertificateModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete Certificate</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="text-center">
            <i class="ri-delete-bin-line display-4 text-danger mb-3"></i>
            <h5>Are you sure?</h5>
            <p class="text-muted mb-0">
              You are about to delete the certificate for <strong id="delete-program-title"></strong>. This action cannot be undone.
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <form method="post" id="deleteCertificateForm" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Delete Certificate</button>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block js %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Image preview for add form
      document.getElementById('add-certificate-image').addEventListener('change', function (e) {
        const file = e.target.files[0]
        const preview = document.getElementById('add-preview')
        const previewImg = document.getElementById('add-preview-img')
    
        if (file) {
          const reader = new FileReader()
          reader.onload = function (e) {
            previewImg.src = e.target.result
            preview.style.display = 'block'
          }
          reader.readAsDataURL(file)
        } else {
          preview.style.display = 'none'
        }
      })
    
      // Edit certificate modal population
      document.querySelectorAll('.edit-certificate-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const certificateId = this.dataset.certificateId
          const programId = this.dataset.programId
    
          // Set form action
          document.getElementById('editCertificateForm').action = '{% url "dashboard:edit_certificate" 0 %}'.replace('0', certificateId)
    
          // Set selected program
          document.getElementById('edit-program').value = programId
        })
      })
    
      // View certificate modal
      document.querySelectorAll('[data-bs-target="#viewCertificateModal"]').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const imageUrl = this.dataset.imageUrl
          const programTitle = this.dataset.programTitle
    
          document.getElementById('view-certificate-image').src = imageUrl
          document.getElementById('view-modal-title').textContent = programTitle + ' - Certificate'
          document.getElementById('download-certificate').href = imageUrl
        })
      })
    
      // Delete certificate modal population
      document.querySelectorAll('.delete-certificate-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const certificateId = this.dataset.certificateId
          const programTitle = this.dataset.programTitle
    
          // Set program title in modal
          document.getElementById('delete-program-title').textContent = programTitle
    
          // Set form action
          document.getElementById('deleteCertificateForm').action = '{% url "dashboard:delete_certificate" 0 %}'.replace('0', certificateId)
        })
      })
    })
  </script>
{% endblock %}
